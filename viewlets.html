


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>22. Writing Viewlets &mdash; Mastering Plone 1.1 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:'',
        VERSION:'1.1',
        COLLAPSE_INDEX:false,
        FILE_SUFFIX:'.html',
        HAS_SOURCE:  true
      };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
    <link rel="top" title="Mastering Plone 1.1 documentation" href="index.html"/>
        <link rel="next" title="23. Deploying your code" href="deployment_code.html"/>
        <link rel="prev" title="21. Social behavior" href="social_behavior.html"/> 

  <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="index.html" class="icon icon-home"> Mastering Plone</a>
        <form class="wy-form" action="search.html" method="get">
  <input type="text" name="q" placeholder="Search docs" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix">
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">1. Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="intro.html#who-are-we">Who are we?</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro.html#who-are-you">Who are you?</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro.html#what-will-we-do">What will we do?</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro.html#what-will-we-not-do">What will we not do?</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro.html#documentation">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro.html#further-reading">Further Reading</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">2. Installation &amp; Setup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation.html#installing-plone">Installing Plone</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#hosting-plone">Hosting Plone</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="plone_training_config/instructions.html">3. Installing Plone for the Training</a><ul>
<li class="toctree-l2"><a class="reference internal" href="plone_training_config/instructions.html#install-virtualbox">Install VirtualBox</a></li>
<li class="toctree-l2"><a class="reference internal" href="plone_training_config/instructions.html#install-and-configure-vagrant">Install and configure Vagrant</a></li>
<li class="toctree-l2"><a class="reference internal" href="plone_training_config/instructions.html#what-vagrant-does">What Vagrant does</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="anatomy.html">4. The Anatomy of Plone</a></li>
<li class="toctree-l1"><a class="reference internal" href="features.html">5. The Features of Plone</a><ul>
<li class="toctree-l2"><a class="reference internal" href="features.html#starting-and-stopping-plone">Starting and Stopping Plone</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#users">Users</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#configure-a-mailserver">Configure a Mailserver</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#walktrough-of-the-ui">Walktrough of the UI</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#content-types">Content-Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#folders">Folders</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#collections">Collections</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#content-rules">Content Rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#history">History</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#manage-members-and-groups">Manage members and groups</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#workflows">Workflows</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#working-copy">Working copy</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#placeful-workflows">Placeful workflows</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="configuring_customizing.html">6. Configuring and Customising Plone through the web</a><ul>
<li class="toctree-l2"><a class="reference internal" href="configuring_customizing.html#the-control-panel">The Control Panel</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuring_customizing.html#portlets">Portlets</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuring_customizing.html#viewlets">Viewlets</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuring_customizing.html#zmi">ZMI</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuring_customizing.html#actions-portal-actions">Actions (portal_actions)</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuring_customizing.html#skins-portal-skins">Skins (portal_skins)</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuring_customizing.html#css-registry-portal-css">CSS-Registry (portal_css)</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuring_customizing.html#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="extending.html">7. Extending Plone</a><ul>
<li class="toctree-l2"><a class="reference internal" href="extending.html#extension-technologies">Extension technologies</a></li>
<li class="toctree-l2"><a class="reference internal" href="extending.html#what-are-components-what-is-zcml">What are components, what is ZCML</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="addons.html">8. Extend Plone with Add-ons</a><ul>
<li class="toctree-l2"><a class="reference internal" href="addons.html#how-to-find-addons">How to find addons</a></li>
<li class="toctree-l2"><a class="reference internal" href="addons.html#installing-addons">Installing Addons</a></li>
<li class="toctree-l2"><a class="reference internal" href="addons.html#ploneformgen">PloneFormGen</a></li>
<li class="toctree-l2"><a class="reference internal" href="addons.html#internationalisation">Internationalisation</a></li>
<li class="toctree-l2"><a class="reference internal" href="addons.html#add-bling-with-collective-plonetruegallery">Add &#8216;bling&#8217; with collective.plonetruegallery</a></li>
<li class="toctree-l2"><a class="reference internal" href="addons.html#customizing-the-design-with-plone-app-themeeditor">Customizing the design with plone.app.themeeditor</a></li>
<li class="toctree-l2"><a class="reference internal" href="addons.html#export-customizations">export customizations</a></li>
<li class="toctree-l2"><a class="reference internal" href="addons.html#inspect-the-package">inspect the package</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="theming.html">9. Theming</a></li>
<li class="toctree-l1"><a class="reference internal" href="buildout_1.html">10. Buildout I</a></li>
<li class="toctree-l1"><a class="reference internal" href="ide.html">11. IDE&#8217;s and Editors</a></li>
<li class="toctree-l1"><a class="reference internal" href="eggs.html">12. Creating your own eggs to customize Plone</a></li>
<li class="toctree-l1"><a class="reference internal" href="dexterity.html">13. Creating content-types with Dexterity</a><ul>
<li class="toctree-l2"><a class="reference internal" href="dexterity.html#what-is-a-content-type">What is a content-type?</a></li>
<li class="toctree-l2"><a class="reference internal" href="dexterity.html#dexterity-and-archetypes-a-comparison">Dexterity and Archetypes - A Comparison</a></li>
<li class="toctree-l2"><a class="reference internal" href="dexterity.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="dexterity.html#creating-content-types-ttw">Creating content-types TTW</a></li>
<li class="toctree-l2"><a class="reference internal" href="dexterity.html#moving-content-types-into-code">Moving content-types into code</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="views_1.html">14. Views I</a><ul>
<li class="toctree-l2"><a class="reference internal" href="views_1.html#a-simple-browser-view">A simple browser view</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="zpt.html">15. Zope Page Templates</a><ul>
<li class="toctree-l2"><a class="reference internal" href="zpt.html#tal-and-tales">TAL and TALES</a></li>
<li class="toctree-l2"><a class="reference internal" href="zpt.html#metal-and-macros">METAL and macros</a></li>
<li class="toctree-l2"><a class="reference internal" href="zpt.html#accessing-plone-from-the-template">Accessing Plone from the template</a></li>
<li class="toctree-l2"><a class="reference internal" href="zpt.html#what-we-missed">What we missed</a></li>
<li class="toctree-l2"><a class="reference internal" href="zpt.html#chameleon">Chameleon</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="zpt_2.html">16. Customizing existing templates</a><ul>
<li class="toctree-l2"><a class="reference internal" href="zpt_2.html#newsitem-view-pt">newsitem_view.pt</a></li>
<li class="toctree-l2"><a class="reference internal" href="zpt_2.html#folder-summary-view-pt">folder_summary_view.pt</a></li>
<li class="toctree-l2"><a class="reference internal" href="zpt_2.html#skin-templates">skin-templates</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="views_2.html">17. Views II: A default view for &#8220;talk&#8221;</a><ul>
<li class="toctree-l2"><a class="reference internal" href="views_2.html#grok">Grok</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="views_3.html">18. Views III: A Talk list</a><ul>
<li class="toctree-l2"><a class="reference internal" href="views_3.html#using-portal-catalog">Using portal_catalog</a></li>
<li class="toctree-l2"><a class="reference internal" href="views_3.html#brains-and-objects">brains and objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="views_3.html#the-template-for-the-listing">The template for the listing</a></li>
<li class="toctree-l2"><a class="reference internal" href="views_3.html#setting-a-custom-view-as-default-view-on-an-object">Setting a custom view as default-view on an object</a></li>
<li class="toctree-l2"><a class="reference internal" href="views_3.html#adding-some-javascript-collective-js-datatables">Adding some javascript (collective.js.datatables)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="custom_search.html">19. Custom search</a><ul>
<li class="toctree-l2"><a class="reference internal" href="custom_search.html#eea-facetednavigation">eea.facetednavigation</a></li>
<li class="toctree-l2"><a class="reference internal" href="custom_search.html#collective-formcriteria">collective.formcriteria</a></li>
<li class="toctree-l2"><a class="reference internal" href="custom_search.html#advanced-topics">Advanced Topics</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ressources.html">20. Ressources</a></li>
<li class="toctree-l1"><a class="reference internal" href="social_behavior.html">21. Social behavior</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">22. Writing Viewlets</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#social-viewlet">social-viewlet</a></li>
<li class="toctree-l2"><a class="reference internal" href="#voting-viewlet">voting-viewlet</a></li>
<li class="toctree-l2"><a class="reference internal" href="#writing-the-viewlet-class">writing the viewlet-class</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-template">the template</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-javascript-code-patrick">The javascript code (Patrick)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#simpleviews-schreiben-patrick">2 Simpleviews schreiben (Patrick)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="deployment_code.html">23. Deploying your code</a></li>
<li class="toctree-l1"><a class="reference internal" href="deployment_sites.html">24. Buildout II: Deploying your site</a><ul>
<li class="toctree-l2"><a class="reference internal" href="deployment_sites.html#the-starzel-buildout">The starzel-buildout</a></li>
<li class="toctree-l2"><a class="reference internal" href="deployment_sites.html#other-tools">Other tools</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="future_of_plone.html">25. The Future of Plone</a></li>
<li class="toctree-l1"><a class="reference internal" href="optional.html">26. Optional</a><ul>
<li class="toctree-l2"><a class="reference internal" href="optional.html#walk-through-a-package">Walk through a package</a></li>
<li class="toctree-l2"><a class="reference internal" href="optional.html#zmi-in-depth">ZMI in depth</a></li>
<li class="toctree-l2"><a class="reference internal" href="optional.html#debugging">Debugging</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top">
        <i data-toggle="wy-nav-top" class="icon icon-reorder"></i>
        <a href="/">Mastering Plone</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <ul class="wy-breadcrumbs">
  <li><a href="index.html">Docs</a> &raquo;</li>
  <li><a href="">22. Writing Viewlets</a></li>
  
</ul>
<hr/>

          
  <div class="section" id="writing-viewlets">
<h1>22. Writing Viewlets<a class="headerlink" href="#writing-viewlets" title="Permalink to this headline">¶</a></h1>
<p>A viewlet is no view but a snippet of html and logic that can be put somewhere in the site.</p>
<ul class="simple">
<li>show <tt class="docutils literal"><span class="pre">/&#64;&#64;manage-viewlets</span></tt></li>
<li>we already customized a viewlet (<tt class="docutils literal"><span class="pre">collophon.pt</span></tt>), now we add a new one</li>
<li>viewlets don&#8217;t save data (portlets do)</li>
</ul>
<div class="section" id="social-viewlet">
<h2>social-viewlet<a class="headerlink" href="#social-viewlet" title="Permalink to this headline">¶</a></h2>
<p>We add a new folder <tt class="docutils literal"><span class="pre">viewlets</span></tt> with an empty <tt class="docutils literal"><span class="pre">__init__.py</span></tt>. This time we don&#8217;t need a <tt class="docutils literal"><span class="pre">configure.zcml</span></tt> and don&#8217;t need to register the folder in our eggs configure.zcml since we use <tt class="docutils literal"><span class="pre">grok</span></tt> to do that for us.</p>
<p>We just add a file viewlets.py containing the viewlet-class:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># encoding=utf-8</span>
<span class="kn">from</span> <span class="nn">five</span> <span class="kn">import</span> <span class="n">grok</span>
<span class="kn">from</span> <span class="nn">plone.app.layout.viewlets</span> <span class="kn">import</span> <span class="n">interfaces</span> <span class="k">as</span> <span class="n">viewletIFs</span>
<span class="kn">from</span> <span class="nn">zope.component</span> <span class="kn">import</span> <span class="n">Interface</span>


<span class="k">class</span> <span class="nc">Social</span><span class="p">(</span><span class="n">grok</span><span class="o">.</span><span class="n">Viewlet</span><span class="p">):</span>
    <span class="n">grok</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="n">Interface</span><span class="p">)</span>
    <span class="n">grok</span><span class="o">.</span><span class="n">viewletmanager</span><span class="p">(</span><span class="n">viewletIFs</span><span class="o">.</span><span class="n">IBelowContentTitle</span><span class="p">)</span>
</pre></div>
</div>
<p>This will add a viewlet to a slot below the title and expect a template <tt class="docutils literal"><span class="pre">social.pt</span></tt> in a folder <tt class="docutils literal"><span class="pre">viewlets_templates</span></tt>.</p>
<p>Let&#8217;s add it:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;social-links&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span>
       <span class="na">class=</span><span class="s">&quot;lanyrd-link&quot;</span>
       <span class="na">tal:define=</span><span class="s">&quot;link viewlet/lanyrd_link | nothing&quot;</span>
       <span class="na">tal:condition=</span><span class="s">&quot;link&quot;</span>
       <span class="na">tal:attributes=</span><span class="s">&quot;href link&quot;</span><span class="nt">&gt;</span>
        See this talk on Lanyrd!
    <span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<p>So now let&#8217;s add some logic to the viewlet-class so that <tt class="docutils literal"><span class="pre">viewlet/lanyrd_link</span></tt> does returns the link:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">five</span> <span class="kn">import</span> <span class="n">grok</span>
<span class="kn">from</span> <span class="nn">plone.app.layout.viewlets</span> <span class="kn">import</span> <span class="n">interfaces</span> <span class="k">as</span> <span class="n">viewletIFs</span>
<span class="kn">from</span> <span class="nn">plonekonf.talk.behavior.social</span> <span class="kn">import</span> <span class="n">ISocial</span>


<span class="k">class</span> <span class="nc">Social</span><span class="p">(</span><span class="n">grok</span><span class="o">.</span><span class="n">Viewlet</span><span class="p">):</span>
    <span class="n">grok</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="n">ISocial</span><span class="p">)</span>
    <span class="n">grok</span><span class="o">.</span><span class="n">viewletmanager</span><span class="p">(</span><span class="n">viewletIFs</span><span class="o">.</span><span class="n">IBelowContentTitle</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">lanyrd_link</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">adapted</span> <span class="o">=</span> <span class="n">ISocial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">adapted</span><span class="o">.</span><span class="n">lanyrd</span>
</pre></div>
</div>
<p>TAG: 17_SOCIAL_VIEWLET</p>
<ul class="simple">
<li>We registered the viewlet to content that have the ISocial Interface.</li>
<li>we adapt the object to it&#8217;s behavior to be able to access the fields of the behavior</li>
<li>we return the link</li>
</ul>
</div>
<div class="section" id="voting-viewlet">
<h2>voting-viewlet<a class="headerlink" href="#voting-viewlet" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Viewlet for IVoteable</li>
<li>the viewlet-template</li>
<li>add jquery include statements</li>
<li>saving the vote on the object using annotations (Patrick)</li>
</ul>
<p>We just added the logic that saves votes on the objects. Now let&#8217;s add the user-interface to it.</p>
<p>Since we want to use the UI on more than one page (not only the talk-view but also the talk-listing) we need to put it somewhere.</p>
<ul class="simple">
<li>To handle the user-input we don&#8217;t use a form but links and ajax.</li>
<li>The voting itself is an fact handles by another view</li>
</ul>
<p>We create a new file voting.py:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># encoding=utf-8</span>
<span class="kn">from</span> <span class="nn">five</span> <span class="kn">import</span> <span class="n">grok</span>
<span class="kn">from</span> <span class="nn">plone.app.layout.viewlets</span> <span class="kn">import</span> <span class="n">interfaces</span> <span class="k">as</span> <span class="n">viewletIFs</span>
<span class="kn">from</span> <span class="nn">zope.component</span> <span class="kn">import</span> <span class="n">Interface</span>


<span class="k">class</span> <span class="nc">Vote</span><span class="p">(</span><span class="n">grok</span><span class="o">.</span><span class="n">Viewlet</span><span class="p">):</span>
    <span class="n">grok</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="n">Interface</span><span class="p">)</span>
    <span class="n">grok</span><span class="o">.</span><span class="n">viewletmanager</span><span class="p">(</span><span class="n">viewletIFs</span><span class="o">.</span><span class="n">IBelowContentTitle</span><span class="p">)</span>
</pre></div>
</div>
<p>This will add a viewlet to a slot below the title and expect a template vote.pt in a folder &#8216;voting_templates&#8217;.</p>
<p>Let&#8217;s create this file without any logic</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;voting&quot;</span><span class="nt">&gt;</span>
    Wanna vote? Write code!
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
  <span class="nx">jq</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="c1">// please add some jQuery-magic</span>
  <span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>
</pre></div>
</div>
<ul class="simple">
<li>restart Plone</li>
<li>show the viewlet</li>
</ul>
</div>
<div class="section" id="writing-the-viewlet-class">
<h2>writing the viewlet-class<a class="headerlink" href="#writing-the-viewlet-class" title="Permalink to this headline">¶</a></h2>
<p>Lets see the final code:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># encoding=utf-8</span>
<span class="kn">from</span> <span class="nn">Products.CMFCore.utils</span> <span class="kn">import</span> <span class="n">getToolByName</span>
<span class="kn">from</span> <span class="nn">Products.CMFDefault.permissions</span> <span class="kn">import</span> <span class="n">ViewManagementScreens</span>
<span class="kn">from</span> <span class="nn">five</span> <span class="kn">import</span> <span class="n">grok</span>
<span class="kn">from</span> <span class="nn">plone.app.layout.viewlets</span> <span class="kn">import</span> <span class="n">interfaces</span> <span class="k">as</span> <span class="n">viewletIFs</span>
<span class="kn">from</span> <span class="nn">plonekonf.talk.interfaces</span> <span class="kn">import</span> <span class="n">IVotable</span><span class="p">,</span> <span class="n">IVoting</span>


<span class="k">class</span> <span class="nc">Vote</span><span class="p">(</span><span class="n">grok</span><span class="o">.</span><span class="n">Viewlet</span><span class="p">):</span>
    <span class="n">grok</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="n">IVotable</span><span class="p">)</span>
    <span class="n">grok</span><span class="o">.</span><span class="n">viewletmanager</span><span class="p">(</span><span class="n">viewletIFs</span><span class="o">.</span><span class="n">IBelowContentTitle</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_vote</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">IVoting</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">voted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vote</span><span class="o">.</span><span class="n">already_voted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">average</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vote</span><span class="o">.</span><span class="n">average_vote</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">membership_tool</span> <span class="o">=</span> <span class="n">getToolByName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s">&#39;portal_membership&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">membership_tool</span><span class="o">.</span><span class="n">checkPermission</span><span class="p">(</span><span class="n">ViewManagementScreens</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_votes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vote</span><span class="o">.</span><span class="n">has_votes</span><span class="p">()</span>
</pre></div>
</div>
<ul class="simple">
<li>we changed the code so that only content that has the interface &#8216;IVotable&#8217; get&#8217;s the viewlet.</li>
<li>_vote returns the context object adapted to the Behavior that adds the vote-functionality. This way we can access all methods that are in IVoting.</li>
<li>voted, average and has_votes do exactly this and return the result of the methods we wrote in IVoting.</li>
<li>is_manager checks if we are managers so only managers can reset the existing votes. To do this we check if the current user can &#8216;ViewManagementScreens&#8217;.</li>
</ul>
</div>
<div class="section" id="the-template">
<h2>the template<a class="headerlink" href="#the-template" title="Permalink to this headline">¶</a></h2>
<p>the final temoplate looks like this:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;voting&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;current_rating&quot;</span> <span class="na">tal:condition=</span><span class="s">&quot;viewlet/has_votes&quot;</span><span class="nt">&gt;</span>
    Average rating: <span class="nt">&lt;span</span> <span class="na">tal:content=</span><span class="s">&quot;viewlet/average&quot;</span><span class="nt">&gt;</span>200<span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;alreadyvoted&quot;</span> <span class="na">class=</span><span class="s">&quot;voting_option&quot;</span><span class="nt">&gt;</span>
    You already rated this voted for this talk!
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;notyetvoted&quot;</span> <span class="na">class=</span><span class="s">&quot;voting_option&quot;</span><span class="nt">&gt;</span>
    Vote for this talk: <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;votes&quot;</span><span class="nt">&gt;&lt;span</span> <span class="na">id=</span><span class="s">&quot;voting_plus&quot;</span><span class="nt">&gt;</span>+1<span class="nt">&lt;/span&gt;</span> <span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">&quot;voting_neutral&quot;</span><span class="nt">&gt;</span>0<span class="nt">&lt;/span&gt;</span> <span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">&quot;voting_negative&quot;</span><span class="nt">&gt;</span>-1<span class="nt">&lt;/span&gt;&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;no_ratings&quot;</span> <span class="na">tal:condition=</span><span class="s">&quot;not: viewlet/has_votes&quot;</span><span class="nt">&gt;</span>
    Be the first one to vote on this talk!
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;tal:reset</span> <span class="na">tal:condition=</span><span class="s">&quot;viewlet/is_manager&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;delete_votings&quot;</span><span class="nt">&gt;</span>
      Delete all votings
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;delete_votings2&quot;</span> <span class="na">class=</span><span class="s">&quot;areyousure warning&quot;</span><span class="nt">&gt;</span>
      Are you sure?
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/tal:reset&gt;</span>

  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span> <span class="na">class=</span><span class="s">&quot;hiddenStructure&quot;</span> <span class="na">id=</span><span class="s">&quot;context_url&quot;</span>
     <span class="na">tal:attributes=</span><span class="s">&quot;href context/absolute_url&quot;</span><span class="nt">&gt;&lt;/a&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">&quot;voted&quot;</span> <span class="na">tal:condition=</span><span class="s">&quot;viewlet/voted&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
  <span class="nx">jq</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="nx">plonekonf</span><span class="p">.</span><span class="nx">init_voting_viewlet</span><span class="p">(</span><span class="nx">jq</span><span class="p">(</span><span class="s2">&quot;.voting&quot;</span><span class="p">));</span>
  <span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>
</pre></div>
</div>
<ul class="simple">
<li>many small parts, most of which will be hidden by javascript unless needed.</li>
<li>we use the methods the class provides</li>
<li>some standard-code to initialize our js-code</li>
</ul>
<p>The css for the template:</p>
<div class="highlight-css"><div class="highlight"><pre><span class="nc">.voting</span> <span class="p">{</span>
    <span class="k">float</span><span class="o">:</span> <span class="k">right</span><span class="p">;</span>
    <span class="k">border</span><span class="o">:</span> <span class="m">1px</span> <span class="k">solid</span> <span class="m">#ddd</span><span class="p">;</span>
    <span class="k">background-color</span><span class="o">:</span> <span class="m">#DDDDDD</span><span class="p">;</span>
    <span class="k">padding</span><span class="o">:</span> <span class="m">0.5em</span> <span class="m">1em</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.voting</span> <span class="nc">.voting_option</span> <span class="p">{</span>
    <span class="k">display</span><span class="o">:</span> <span class="n">None</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.areyousure</span> <span class="p">{</span>
    <span class="k">display</span><span class="o">:</span> <span class="n">None</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.voting</span> <span class="nt">div</span><span class="nc">.votes</span> <span class="nt">span</span> <span class="p">{</span>
    <span class="k">border</span><span class="o">:</span> <span class="m">0</span> <span class="k">solid</span> <span class="m">#DDDDDD</span><span class="p">;</span>
    <span class="k">cursor</span><span class="o">:</span> <span class="k">pointer</span><span class="p">;</span>
    <span class="k">float</span><span class="o">:</span> <span class="k">left</span><span class="p">;</span>
    <span class="k">margin</span><span class="o">:</span> <span class="m">0</span> <span class="m">0.2em</span><span class="p">;</span>
    <span class="k">padding</span><span class="o">:</span> <span class="m">0</span> <span class="m">0.5em</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.votes</span> <span class="p">{</span>
    <span class="k">display</span><span class="o">:</span> <span class="k">inline</span><span class="p">;</span>
    <span class="k">float</span><span class="o">:</span> <span class="k">right</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.voting</span> <span class="nf">#voting_plus</span> <span class="p">{</span>
    <span class="k">background-color</span><span class="o">:</span> <span class="n">LimeGreen</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.voting</span> <span class="nf">#voting_neutral</span> <span class="p">{</span>
    <span class="k">background-color</span><span class="o">:</span> <span class="nb">yellow</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.voting</span> <span class="nf">#voting_negative</span> <span class="p">{</span>
    <span class="k">background-color</span><span class="o">:</span> <span class="nb">red</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="the-javascript-code-patrick">
<h2>The javascript code (Patrick)<a class="headerlink" href="#the-javascript-code-patrick" title="Permalink to this headline">¶</a></h2>
<div class="highlight-js"><div class="highlight"><pre><span class="cm">/*global location: false, window: false, jQuery: false */</span>
<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">starzel_votablebehavior</span><span class="p">)</span> <span class="p">{</span>
    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
    <span class="nx">starzel_votablebehavior</span><span class="p">.</span><span class="nx">init_voting_viewlet</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">notyetvoted</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;#notyetvoted&quot;</span><span class="p">),</span>
            <span class="nx">alreadyvoted</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;#alreadyvoted&quot;</span><span class="p">),</span>
            <span class="nx">delete_votings</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;#delete_votings&quot;</span><span class="p">),</span>
            <span class="nx">delete_votings2</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;#delete_votings2&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;#voted&quot;</span><span class="p">).</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">alreadyvoted</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">notyetvoted</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">vote</span><span class="p">(</span><span class="nx">rating</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="nx">inner_vote</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;#context_url&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/vote&#39;</span><span class="p">,</span> <span class="p">{</span>
                    <span class="nx">rating</span><span class="o">:</span> <span class="nx">rating</span>
                <span class="p">},</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span>
                <span class="p">});</span>
            <span class="p">};</span>
        <span class="p">}</span>

        <span class="nx">context</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;#voting_plus&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">vote</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
        <span class="nx">context</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;#voting_neutral&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">vote</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
        <span class="nx">context</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;#voting_negative&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">vote</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>

        <span class="nx">delete_votings</span><span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">delete_votings2</span><span class="p">.</span><span class="nx">toggle</span><span class="p">();</span>
        <span class="p">});</span>
        <span class="nx">delete_votings2</span><span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;#context_url&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/clearvotes&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">};</span>
<span class="p">}(</span><span class="nx">jQuery</span><span class="p">,</span> <span class="nb">window</span><span class="p">.</span><span class="nx">starzel_votablebehavior</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">starzel_votablebehavior</span> <span class="o">||</span> <span class="p">{}));</span>
</pre></div>
</div>
<p>Zunächst fragen wir den Marker ab, der anzeigt, ob der aktuelle
Benutzer schon abgestimmt hat. Abhängig davon zeigen bieten wir die
Abstimmungsmöglichkeit ab.</p>
<p>Danach schreiben wir die Funktion, welche die Stimme abgibt.
Wir sind schreibfaul, deswegen schreiben wir eine Funktion, die eine
Funktion zurückgibt.</p>
<p>Danach setzen wir für die einzelnen Abstimmungsmöglichkeiten, einen
Clickhandler</p>
<p>Wie funktioniert das? Wir rufen vote auf, die liefert eine Methode
zurück. Als Clickhandler speichert man normalerweise immer eine
Methode. Wenn nun jemand auf einen der Texte klickt, wir die Methode
inner_vote aufgerufen. Innerhalb der inner_vote Methode können wir
noch immer die gültige rating Variable aufrufen, die wir mit vote
übergeben haben. Die Methode die also als clickhandler für
#voting_plus aufgerufen wurde, sieht eine 1 wenn sie rating abfragt,
#voting_neutral sieht die 0 und so weiter.</p>
<p>Dann rufen wir die Methode post aus jquery auf, als ersten Parameter
suchen wir uns aus dem html die context_url die wir dort versteckt
haben, als Post Parameter übergeben wir das Rating, und zum Schluss
kommt die Methode, welche nach erfolgreichem Request aufgerufen
wird, und die Seite neu lädt.</p>
<p>Danach schreiben wir noch die Handler um per Two Step Verfahren die
Stimmen löschen zu können.</p>
<p>Jetzt müssen wir noch die Methoden schreiben, die per HTTP Post
aufgerufen werden.</p>
</div>
<div class="section" id="simpleviews-schreiben-patrick">
<h2>2 Simpleviews schreiben (Patrick)<a class="headerlink" href="#simpleviews-schreiben-patrick" title="Permalink to this headline">¶</a></h2>
<p>Diese Views haben IVotable als Context, es gibt sie also nur auf
Objekten welche Votable sind.</p>
<p>ClearVotes ist nochmal mit der Management Permission geschützt. Ein
Hacker der den Javascript code von eben analysiert, könnte das
Löschen manuell antriggern, dadurch, das der View durch eine
Managementpermission geschützt ist, kann er keinen Schaden
anrichten. Ansonsten rufen diese Views nur Methoden des Behaviors
auf.</p>
</div>
</div>


          <footer>
  
    <div class="rst-footer-buttons">
      
        <a href="deployment_code.html" class="btn btn-neutral float-right" title="23. Deploying your code"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="social_behavior.html" class="btn btn-neutral" title="21. Social behavior"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <p>
      &copy; Copyright 2013, Philip Bauer, Patrick Gerken.
  </p>

  <a href="https://www.github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="http://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  

</body>
</html>